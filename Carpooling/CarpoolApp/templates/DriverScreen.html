<!DOCTYPE html>
<html>
<head>
    <title>Driver Dashboard - Carpool DApp</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Driver Dashboard</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Welcome, {{ driver }}</span>
                <a class="nav-link" href="{% url 'logout' %}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% if data %}
        <div class="alert alert-info alert-dismissible fade show">
            {{ data }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% if token_hint %}
        <div class="alert alert-warning alert-dismissible fade show">
            <strong>Payment Pending:</strong> {{ data }}
            <br><small>Passenger will pay using CarpoolToken via MetaMask</small>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- Payment Received Notification -->
        <div id="paymentReceivedAlert" class="alert alert-success alert-dismissible fade show" style="display: none;">
            <h5>üí∞ Payment Received!</h5>
            <p id="paymentReceivedMessage"></p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Wallet & Token Info -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5>Your Driver Wallet</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Connected Address:</strong> 
                                    <span id="driverAddress">{{ wallet_address|default:"Not connected" }}</span>
                                </p>
                                <p><strong>CPT Balance:</strong> 
                                    <span id="tokenBalance">{{ token_balance }}</span> CPT
                                </p>
                                <p><strong>Network:</strong> 
                                    <span id="networkInfo">Ganache Local</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <div class="btn-group-vertical w-100">
                                    <button onclick="connectMetaMask()" class="btn btn-outline-primary btn-sm mb-2">
                                        üîÑ Reconnect MetaMask
                                    </button>
                                    <button onclick="getTestTokens()" class="btn btn-outline-success btn-sm mb-2">
                                        üí∞ Get More Test Tokens
                                    </button>
                                    <button onclick="addTokenToMetaMask()" class="btn btn-outline-info btn-sm mb-2">
                                        ‚ûï Add CPT to MetaMask
                                    </button>
                                    <button onclick="refreshBalance()" class="btn btn-outline-warning btn-sm">
                                        üîÑ Refresh Balance
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h5 id="completedRidesCount">0</h5>
                        <p>Completed Rides</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h5 id="pendingPaymentsCount">0</h5>
                        <p>Pending Payments</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h5 id="activeRidesCount">0</h5>
                        <p>Active Rides</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>Create New Ride</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{% url 'AddRide' %}" id="rideForm">
                            {% csrf_token %}
                            <div class="mb-2">
                                <label class="form-label">Location Name</label>
                                <input type="text" class="form-control" name="t1" required placeholder="e.g., Downtown Mall">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Latitude</label>
                                <input type="number" step="any" class="form-control" name="t2" required placeholder="e.g., 40.7128">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Longitude</label>
                                <input type="number" step="any" class="form-control" name="t3" required placeholder="e.g., -74.0060">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Available Seats</label>
                                <input type="number" class="form-control" name="t4" required min="1" max="8" placeholder="1-8">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Ride Date</label>
                                <input type="date" class="form-control" name="ride_date" value="{{ today }}">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Ride Time</label>
                                <input type="time" class="form-control" name="ride_time" value="12:00">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Create Ride</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5>Complete Ride & Request Payment</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{% url 'RideCompleteAction' %}" id="completeRideForm">
                            {% csrf_token %}
                            <div class="mb-2">
                                <label class="form-label">Ride ID</label>
                                <input type="text" class="form-control" name="t1" required placeholder="Enter Ride ID" id="rideIdInput">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Passenger Username</label>
                                <input type="text" class="form-control" name="t2" required placeholder="Passenger's username" id="passengerInput">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Miles Traveled</label>
                                <input type="number" step="0.1" class="form-control" name="t3" required placeholder="e.g., 5.5" id="milesInput">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Total Amount (CPT Tokens)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="t4" required placeholder="e.g., 10" min="1" id="amountInput">
                                    <span class="input-group-text">CPT</span>
                                </div>
                                <small class="text-muted">Suggested: <span id="suggestedAmount">0</span> CPT (<span id="ratePerMile">2</span> CPT/mile)</small>
                            </div>
                            <button type="submit" class="btn btn-success w-100">Complete Ride & Request Payment</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Payments -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5>‚è≥ Pending Payments</h5>
                    </div>
                    <div class="card-body">
                        <div id="pendingPayments">
                            <p>Loading pending payments...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Rides -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5>‚úÖ Completed Rides</h5>
                    </div>
                    <div class="card-body">
                        <div id="completedRides">
                            <p>Loading completed rides...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduled Rides -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5>Your Scheduled Rides</h5>
                    </div>
                    <div class="card-body">
                        <div id="scheduledRides">
                            <p>Loading your scheduled rides...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    let web3;

    // CSRF Token helper function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initialize Web3
    async function initWeb3() {
        if (typeof window.ethereum !== 'undefined') {
            web3 = new Web3(window.ethereum);
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                console.log('MetaMask connected');
                await refreshBalance();
                return true;
            } catch (error) {
                console.error('User denied account access');
                return false;
            }
        } else {
            alert('MetaMask not detected. Please install MetaMask.');
            return false;
        }
    }

    // Connect MetaMask manually
    async function connectMetaMask() {
        const connected = await initWeb3();
        if (connected) {
            alert('MetaMask connected successfully!');
        }
    }

    // Refresh token balance
    async function refreshBalance() {
        try {
            const accounts = await web3.eth.getAccounts();
            const driverAddress = accounts[0];
            
            if (driverAddress) {
                document.getElementById('driverAddress').textContent = driverAddress;
                
                const tokenInfo = await fetch('/provide_token_info/').then(r => r.json());
                if (!tokenInfo.error) {
                    const tokenContract = new web3.eth.Contract(tokenInfo.abi, tokenInfo.address);
                    const balance = await tokenContract.methods.balanceOf(driverAddress).call();
                    const balanceInTokens = web3.utils.fromWei(balance.toString(), 'ether');
                    document.getElementById('tokenBalance').textContent = balanceInTokens;
                }
            }
        } catch (error) {
            console.error('Error checking balance:', error);
        }
    }

    // Add token to MetaMask
    async function addTokenToMetaMask() {
        try {
            const tokenInfo = await fetch('/provide_token_info/').then(r => r.json());
            
            if (tokenInfo.error) {
                alert('Could not get token info: ' + tokenInfo.error);
                return;
            }

            const wasAdded = await window.ethereum.request({
                method: 'wallet_watchAsset',
                params: {
                    type: 'ERC20',
                    options: {
                        address: tokenInfo.address,
                        symbol: 'CPT',
                        decimals: 18,
                    },
                },
            });

            if (wasAdded) {
                alert('‚úÖ CPT token added to MetaMask!');
            } else {
                alert('Token already added to MetaMask.');
            }
        } catch (error) {
            console.error('Error adding token to MetaMask:', error);
        }
    }

    // Get test tokens
    async function getTestTokens() {
        try {
            const response = await fetch('/distribute_tokens/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({username: '{{ driver }}'})
            });
            
            const result = await response.json();
            alert(result.message);
            
            if (result.status === 'success') {
                setTimeout(() => {
                    refreshBalance();
                }, 2000);
            }
        } catch (error) {
            console.error('Error getting tokens:', error);
        }
    }

    // Load scheduled rides
    async function loadScheduledRides() {
        try {
            const response = await fetch('/get_scheduled_rides/');
            const data = await response.json();
            
            const container = document.getElementById('scheduledRides');
            let activeRides = 0;
            
            if (data.scheduled_rides && data.scheduled_rides.length > 0) {
                let html = '<div class="list-group">';
                
                data.scheduled_rides.forEach(ride => {
                    if (ride.driver === '{{ driver }}') {
                        if (ride.status === 'waiting') activeRides++;
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6>Ride to ${ride.location}</h6>
                                        <small class="text-muted">ID: ${ride.id} | Date: ${ride.date} ${ride.time}</small>
                                    </div>
                                    <span class="badge bg-${ride.status === 'waiting' ? 'success' : 'secondary'}">${ride.status}</span>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p>No scheduled rides found.</p>';
            }
            
            document.getElementById('activeRidesCount').textContent = activeRides;
            
        } catch (error) {
            console.error('Error loading scheduled rides:', error);
        }
    }

    // Load pending payments
    async function loadPendingPayments() {
        try {
            const response = await fetch('/get_pending_payments/');
            const data = await response.json();
            
            const container = document.getElementById('pendingPayments');
            let pendingCount = 0;
            
            if (data.pending_payments && data.pending_payments.length > 0) {
                let html = '<div class="list-group">';
                
                data.pending_payments.forEach(payment => {
                    if (payment.driver === '{{ driver }}') {
                        pendingCount++;
                        html += `
                            <div class="list-group-item list-group-item-warning">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6>Ride ${payment.ride_id}</h6>
                                        <small class="text-muted">Passenger: ${payment.passenger_id} | Miles: ${payment.miles}</small>
                                    </div>
                                    <div class="text-end">
                                        <strong class="text-warning">${payment.amount} CPT</strong><br>
                                        <small>Waiting for payment</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="text-success">‚úÖ No pending payments</p>';
            }
            
            document.getElementById('pendingPaymentsCount').textContent = pendingCount;
            
        } catch (error) {
            console.error('Error loading pending payments:', error);
        }
    }

    // Load completed rides
    // Load completed & paid rides
async function loadCompletedRides() {
    try {
        const response = await fetch('/get_completed_paid_rides/');
        const data = await response.json();
        
        const container = document.getElementById('completedRides');
        let completedCount = 0;
        let totalEarnings = 0;
        
        if (data.paid_rides && data.paid_rides.length > 0) {
            let html = '<div class="list-group">';
            
            data.paid_rides.forEach(ride => {
                completedCount++;
                totalEarnings += parseFloat(ride.amount) || 0;
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>Ride ${ride.ride_id}</h6>
                                <small class="text-muted">
                                    Passenger: ${ride.passenger} | 
                                    Miles: ${ride.miles} | 
                                    ${ride.tx_hash ? `TX: ${ride.tx_hash.substring(0, 10)}...` : ''}
                                </small>
                            </div>
                            <div class="text-end">
                                <strong class="text-success">${ride.amount} CPT</strong><br>
                                <span class="badge bg-success">Paid</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = `
                <div class="alert alert-info">
                    <h6>No Paid Rides Yet</h6>
                    <p>When passengers complete payments for your rides, they will appear here.</p>
                    <small>Check "Pending Payments" for completed rides waiting for payment.</small>
                </div>
            `;
        }
        
        document.getElementById('completedRidesCount').textContent = completedCount;
        
    } catch (error) {
        console.error('Error loading completed rides:', error);
        document.getElementById('completedRides').innerHTML = '<p class="text-danger">Error loading completed rides</p>';
    }
}

    // Show payment received notification
    function showPaymentReceived(amount) {
        document.getElementById('paymentReceivedMessage').textContent = 
            `You received ${amount} CPT! Balance updated.`;
        document.getElementById('paymentReceivedAlert').style.display = 'block';
        
        setTimeout(() => {
            refreshBalance();
            loadPendingPayments();
            loadCompletedRides();
        }, 2000);
    }

    // Auto-calculate suggested amount based on miles
    function calculateSuggestedAmount() {
        const miles = parseFloat(document.getElementById('milesInput').value) || 0;
        const ratePerMile = 2;
        const suggested = miles * ratePerMile;
        document.getElementById('suggestedAmount').textContent = suggested.toFixed(2);
        document.getElementById('amountInput').value = suggested.toFixed(2);
    }

    // Auto-refresh data
    function startAutoRefresh() {
        setInterval(() => {
            refreshBalance();
            loadPendingPayments();
            loadCompletedRides();
            loadScheduledRides();
        }, 10000);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log("=== DRIVERSCREEN INITIALIZATION ===");
        initWeb3().then(() => {
            loadScheduledRides();
            loadPendingPayments();
            loadCompletedRides();
            startAutoRefresh();
        });

        document.getElementById('milesInput').addEventListener('input', calculateSuggestedAmount);
    });
    </script>
</body>
</html>