<!DOCTYPE html>
<html>
<head>
    <title>Passenger Dashboard - Carpool DApp</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Passenger Dashboard</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Welcome, {{ user }}</span>
                <a class="nav-link" href="{% url 'map_view' %}">Map View</a>
                <a class="nav-link" href="{% url 'Ratings' %}">Rate Drivers</a>
                <a class="nav-link" href="{% url 'logout' %}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% if data %}
        <div class="alert alert-info">{{ data|safe }}</div>
        {% endif %}

        <!-- Payment Notification Alert -->
        <div id="paymentNotification" class="alert alert-warning alert-dismissible fade show" style="display: none;">
            <h5>üí≥ Payment Required!</h5>
            <p id="notificationMessage">You have pending payments for completed rides.</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Wallet & Token Info Card -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5>Your MetaMask Wallet</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Connected Address:</strong> 
                                    <span id="userAddress">{{ wallet_address|default:"Not connected" }}</span>
                                </p>
                                <p><strong>CPT Balance:</strong> 
                                    <span id="tokenBalance">{{ token_balance }}</span> CPT
                                </p>
                                <p><strong>Network:</strong> 
                                    <span id="networkInfo">Ganache Local</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <div class="btn-group-vertical w-100">
                                    <button onclick="connectMetaMask()" class="btn btn-outline-primary btn-sm mb-2">
                                        üîÑ Reconnect MetaMask
                                    </button>
                                    <button onclick="getTestTokens()" class="btn btn-outline-success btn-sm mb-2">
                                        üí∞ Get Test Tokens (1000 CPT)
                                    </button>
                                    <button onclick="addTokenToMetaMask()" class="btn btn-outline-info btn-sm mb-2">
                                        ‚ûï Add CPT to MetaMask
                                    </button>
                                    <button onclick="verifyUser()" class="btn btn-outline-warning btn-sm">
                                        ‚úÖ Verify Account
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5>Recent Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div id="transactionHistory">
                            <p>Loading transaction history...</p>
                        </div>
                        <button onclick="loadTransactionHistory()" class="btn btn-sm btn-outline-primary mt-2">
                            üîÑ Refresh Transactions
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Find Rides Card -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>Find Nearby Drivers</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{% url 'ViewDrivers' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label">Destination</label>
                                <input type="text" class="form-control" name="t1" required placeholder="Enter your destination">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Your Latitude</label>
                                    <input type="number" step="any" class="form-control" name="t2" required placeholder="e.g., 40.7128">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Your Longitude</label>
                                    <input type="number" step="any" class="form-control" name="t3" required placeholder="e.g., -74.0060">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Find Drivers</button>
                        </form>
                        <div class="mt-3">
                            <a href="{% url 'map_view' %}" class="btn btn-outline-secondary btn-sm">Use Map View Instead</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COMPLETED RIDES REQUIRING PAYMENT -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5>üö® Rides Requiring Payment</h5>
                    </div>
                    <div class="card-body">
                        <div id="completedRides">
                            <p>Checking for completed rides...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduled Rides -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5>Your Scheduled Rides</h5>
                    </div>
                    <div class="card-body">
                        <div id="scheduledRides">
                            <p>Loading scheduled rides...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Payments Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5>Pending Payments</h5>
                    </div>
                    <div class="card-body">
                        <div id="pendingPayments">
                            <p>Loading pending payments...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Complete Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Ride ID:</strong> <span id="paymentRideId"></span></p>
                    <p><strong>Driver:</strong> <span id="paymentDriver"></span></p>
                    <p><strong>Amount:</strong> <span id="paymentAmount"></span> CPT</p>
                    <p><strong>Your Balance:</strong> <span id="paymentBalance">{{ token_balance }}</span> CPT</p>
                    <div class="d-grid gap-2">
                        <button onclick="processPayment()" class="btn btn-success btn-lg">Pay with MetaMask</button>
                    </div>
                    <div id="paymentStatus" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div class="modal fade" id="verificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Verify Your Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>For enhanced safety, verify your account.</p>
                    <button onclick="submitVerification()" class="btn btn-warning">Start Verification</button>
                    <div id="verificationStatus" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
    let currentPayment = null;
    let web3;

    // CSRF Token helper function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initialize Web3
    async function initWeb3() {
        if (typeof window.ethereum !== 'undefined') {
            web3 = new Web3(window.ethereum);
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                console.log('MetaMask connected');
                await checkTokenBalance();
                return true;
            } catch (error) {
                console.error('User denied account access:', error);
                return false;
            }
        } else {
            console.log('Please install MetaMask to use this feature!');
            alert('MetaMask not detected. Please install MetaMask to use this application.');
            return false;
        }
    }

    // Connect MetaMask manually
    async function connectMetaMask() {
        const connected = await initWeb3();
        if (connected) {
            alert('MetaMask connected successfully!');
            location.reload();
        }
    }

    // Check token balance - FIXED BigInt version
    async function checkTokenBalance() {
        try {
            const accounts = await web3.eth.getAccounts();
            const userAddress = accounts[0];
            
            if (userAddress) {
                document.getElementById('userAddress').textContent = userAddress;
                
                const tokenInfo = await fetch('/provide_token_info/').then(r => r.json());
                if (!tokenInfo.error) {
                    const tokenContract = new web3.eth.Contract(tokenInfo.abi, tokenInfo.address);
                    const balance = await tokenContract.methods.balanceOf(userAddress).call();
                    // Convert BigInt to string before processing
                    const balanceInTokens = web3.utils.fromWei(balance.toString(), 'ether');
                    document.getElementById('tokenBalance').textContent = balanceInTokens;
                    document.getElementById('paymentBalance').textContent = balanceInTokens;
                }
            }
        } catch (error) {
            console.error('Error checking balance:', error);
        }
    }

    // Load completed rides requiring payment
    async function loadCompletedRides() {
        try {
            const response = await fetch('/get_completed_rides_for_passenger/');
            const data = await response.json();
            
            const container = document.getElementById('completedRides');
            
            if (data.completed_rides && data.completed_rides.length > 0) {
                // Show payment notification
                document.getElementById('paymentNotification').style.display = 'block';
                document.getElementById('notificationMessage').textContent = 
                    `You have ${data.completed_rides.length} completed ride(s) requiring payment.`;
                
                let html = `
                    <div class="alert alert-danger">
                        <strong>üö® Immediate Action Required!</strong><br>
                        You have ${data.completed_rides.length} completed ride(s) waiting for payment.
                    </div>
                    <div class="list-group">
                `;
                
                data.completed_rides.forEach(ride => {
                    html += `
                        <div class="list-group-item list-group-item-danger">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Ride ${ride.ride_id} with ${ride.driver}</h6>
                                    <small class="text-muted">
                                        Distance: ${ride.miles} miles | Status: ${ride.status}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger">${ride.amount} CPT</strong><br>
                                    <button onclick="initiatePayment('${ride.ride_id}', '${ride.driver}', '${ride.amount}')" 
                                            class="btn btn-sm btn-danger mt-1">
                                        üí≥ Pay Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="text-success">‚úÖ No rides requiring payment at the moment.</p>';
                document.getElementById('paymentNotification').style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading completed rides:', error);
            document.getElementById('completedRides').innerHTML = '<p class="text-danger">Error loading completed rides. Please try again.</p>';
        }
    }

    // Add token to MetaMask
    async function addTokenToMetaMask() {
        try {
            const tokenInfo = await fetch('/provide_token_info/').then(r => r.json());
            
            if (tokenInfo.error) {
                alert('Could not get token info: ' + tokenInfo.error);
                return;
            }

            const wasAdded = await window.ethereum.request({
                method: 'wallet_watchAsset',
                params: {
                    type: 'ERC20',
                    options: {
                        address: tokenInfo.address,
                        symbol: 'CPT',
                        decimals: 18,
                    },
                },
            });

            if (wasAdded) {
                alert('‚úÖ CPT token added to MetaMask!');
            } else {
                alert('User canceled token addition');
            }
        } catch (error) {
            console.error('Error adding token to MetaMask:', error);
            alert('Error adding token to MetaMask: ' + error.message);
        }
    }

    // Get test tokens
    async function getTestTokens() {
        try {
            const response = await fetch('/distribute_tokens/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({username: '{{ user }}'})
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                alert('‚úÖ ' + result.message);
                // Refresh balance and page
                setTimeout(() => {
                    checkTokenBalance();
                    location.reload();
                }, 2000);
            } else {
                alert('‚ùå ' + result.message);
            }
        } catch (error) {
            console.error('Error getting tokens:', error);
            alert('‚ùå Error getting test tokens: ' + error.message);
        }
    }

    // Load scheduled rides
    async function loadScheduledRides() {
        try {
            const response = await fetch('/get_scheduled_rides/');
            const data = await response.json();
            
            const container = document.getElementById('scheduledRides');
            if (data.scheduled_rides && data.scheduled_rides.length === 0) {
                container.innerHTML = '<p>No scheduled rides found.</p>';
                return;
            }
            
            let html = '<div class="list-group">';
            data.scheduled_rides.forEach(ride => {
                if (ride.driver !== '{{ user }}') {
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Ride to ${ride.location}</h6>
                                    <small class="text-muted">Driver: ${ride.driver} | Date: ${ride.date} ${ride.time}</small>
                                </div>
                                <span class="badge bg-${ride.status === 'waiting' ? 'success' : 'secondary'}">${ride.status}</span>
                            </div>
                        </div>
                    `;
                }
            });
            html += '</div>';
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading scheduled rides:', error);
            document.getElementById('scheduledRides').innerHTML = '<p>Error loading scheduled rides.</p>';
        }
    }

    // Load pending payments
    async function loadPendingPayments() {
        try {
            const response = await fetch('/get_pending_payments/');
            const data = await response.json();
            
            const container = document.getElementById('pendingPayments');
            if (data.pending_payments && data.pending_payments.length === 0) {
                container.innerHTML = '<p>No pending payments.</p>';
                return;
            }
            
            let html = '<div class="list-group">';
            data.pending_payments.forEach(payment => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>Ride ${payment.ride_id} with ${payment.driver}</h6>
                                <small class="text-muted">Distance: ${payment.miles} miles</small>
                            </div>
                            <div class="text-end">
                                <strong class="text-success">${payment.amount} CPT</strong><br>
                                <button onclick="initiatePayment('${payment.ride_id}', '${payment.driver}', '${payment.amount}')" 
                                        class="btn btn-sm btn-primary mt-1">
                                    Pay Now
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading payments:', error);
            document.getElementById('pendingPayments').innerHTML = '<p>Error loading pending payments.</p>';
        }
    }

    // Load transaction history - FIXED BigInt version
    async function loadTransactionHistory() {
        try {
            const accounts = await web3.eth.getAccounts();
            const userAddress = accounts[0];
            
            const tokenInfo = await fetch('/provide_token_info/').then(r => r.json());
            if (tokenInfo.error) {
                document.getElementById('transactionHistory').innerHTML = '<p>Could not load token info</p>';
                return;
            }
            
            const tokenContract = new web3.eth.Contract(tokenInfo.abi, tokenInfo.address);
            
            // Get recent Transfer events for this user
            const transferEvents = await tokenContract.getPastEvents('Transfer', {
                filter: { from: userAddress },
                fromBlock: 0,
                toBlock: 'latest'
            });
            
            const container = document.getElementById('transactionHistory');
            
            if (transferEvents.length === 0) {
                container.innerHTML = '<p>No recent transactions found.</p>';
                return;
            }
            
            let html = '<div class="list-group">';
            
            // Show last 5 transactions
            transferEvents.slice(-5).reverse().forEach(event => {
                const args = event.returnValues;
                // Convert BigInt to string for display
                const amount = web3.utils.fromWei(args.value.toString(), 'ether');
                const timestamp = new Date().toLocaleString();
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>Transfer: ${amount} CPT</strong><br>
                                <small>To: ${args.to.substring(0, 10)}... | TX: ${event.transactionHash.substring(0, 15)}...</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success">Completed</span><br>
                                <small>${timestamp}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading transaction history:', error);
            document.getElementById('transactionHistory').innerHTML = '<p>Error loading transactions</p>';
        }
    }

    // Initiate payment process
    async function initiatePayment(rideId, driver, amount) {
        currentPayment = { rideId, driver, amount };
        document.getElementById('paymentRideId').textContent = rideId;
        document.getElementById('paymentDriver').textContent = driver;
        document.getElementById('paymentAmount').textContent = amount;
        document.getElementById('paymentStatus').innerHTML = '';
        
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        paymentModal.show();
    }

    // Process payment with MetaMask - FIXED BigInt version
    async function processPayment() {
        if (!currentPayment) return;
        
        const statusDiv = document.getElementById('paymentStatus');
        statusDiv.innerHTML = '<div class="alert alert-info">Starting payment process...</div>';
        
        try {
            console.log("=== PAYMENT PROCESS STARTED ===");
            
            // Ensure MetaMask is connected
            if (typeof window.ethereum === 'undefined') {
                throw new Error('MetaMask not installed');
            }
            
            await initWeb3();
            
            // Get driver's wallet address
            const walletResponse = await fetch('/get_driver_wallet/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({driver_username: currentPayment.driver})
            });
            const walletData = await walletResponse.json();
            
            if (walletData.error) {
                throw new Error(walletData.error);
            }
            
            console.log("Driver wallet:", walletData.wallet_address);
            
            // Get token info
            const tokenInfo = await fetch('/provide_token_info/').then(r => r.json());
            if (tokenInfo.error) {
                throw new Error(tokenInfo.error);
            }
            
            console.log("Token contract:", tokenInfo.address);
            
            // Convert amount to wei - FIXED: Use string conversion
            const amountInWei = web3.utils.toWei(currentPayment.amount.toString(), 'ether');
            console.log("Amount in wei:", amountInWei);
            
            // Create token contract instance
            const tokenContract = new web3.eth.Contract(tokenInfo.abi, tokenInfo.address);
            
            // Get accounts FROM METAMASK
            const accounts = await web3.eth.getAccounts();
            const fromAddress = accounts[0];
            
            if (!fromAddress) {
                throw new Error('No MetaMask account connected. Please connect MetaMask.');
            }
            
            console.log("Paying from:", fromAddress);
            console.log("Paying to:", walletData.wallet_address);
            console.log("Amount:", currentPayment.amount, "CPT");
            
            // Check balance first - FIXED: Convert BigInt to string
            const balance = await tokenContract.methods.balanceOf(fromAddress).call();
            const balanceInTokens = web3.utils.fromWei(balance.toString(), 'ether');
            console.log("Current balance:", balanceInTokens, "CPT");
            
            if (parseFloat(balanceInTokens) < parseFloat(currentPayment.amount)) {
                throw new Error(`Insufficient balance! You have ${balanceInTokens} CPT but need ${currentPayment.amount} CPT.`);
            }
            
            // Estimate gas - FIXED: Handle BigInt
            const gasEstimate = await tokenContract.methods.transfer(walletData.wallet_address, amountInWei)
                .estimateGas({ from: fromAddress });
            
            console.log("Gas estimate:", gasEstimate.toString());
            
            // Send transaction THROUGH METAMASK ONLY
            statusDiv.innerHTML = '<div class="alert alert-warning">ü¶ä MetaMask should open now. Please confirm the transaction...</div>';
            
            const tx = await tokenContract.methods.transfer(walletData.wallet_address, amountInWei)
                .send({ 
                    from: fromAddress,
                    gas: (BigInt(gasEstimate) + BigInt(10000)).toString()
                });
            
            console.log("‚úÖ MetaMask Transaction successful!", tx);
            
            const realTransactionHash = tx.transactionHash;
            console.log("Real Transaction Hash:", realTransactionHash);
            
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ MetaMask Transaction Submitted!<br>
                    <strong>Hash:</strong> ${realTransactionHash}<br>
                    <small>Waiting for confirmation...</small>
                </div>
            `;
            
            // Wait for transaction to be mined
            const receipt = await web3.eth.getTransactionReceipt(realTransactionHash);
            
            if (!receipt) {
                statusDiv.innerHTML += '<div class="alert alert-warning">‚è≥ Waiting for transaction to be mined...</div>';
                await new Promise(resolve => setTimeout(resolve, 3000));
            }
            
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Transaction Confirmed!<br>
                    <strong>Hash:</strong> ${realTransactionHash}<br>
                    <strong>Block:</strong> ${tx.blockNumber || 'Pending'}<br>
                </div>
            `;
            
            // Verify payment with backend - FIXED: Convert BigInt to string for JSON
            statusDiv.innerHTML += '<div class="alert alert-info">Verifying payment on backend...</div>';
            
            const verification = await fetch('/verify_token_payment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    tx_hash: realTransactionHash,
                    expected_to: walletData.wallet_address,
                    expected_amount: amountInWei.toString(),
                    passenger: '{{ user }}',
                    rid: currentPayment.rideId
                })
            });
            
            const result = await verification.json();
            
            if (result.status === 'ok') {
                statusDiv.innerHTML += '<div class="alert alert-success mt-2">‚úÖ Payment fully processed!</div>';
                
                // Update balances and refresh
                setTimeout(() => {
                    checkTokenBalance();
                    loadCompletedRides();
                    loadPendingPayments();
                    loadTransactionHistory();
                    
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    }, 3000);
                }, 2000);
                
            } else {
                throw new Error(result.error || 'Payment verification failed');
            }
            
        } catch (error) {
            console.error('‚ùå Payment error:', error);
            
            if (error.code === 4001) {
                statusDiv.innerHTML = '<div class="alert alert-warning">‚ùå Transaction rejected in MetaMask. You clicked "Reject".</div>';
            } else if (error.message.includes('insufficient funds')) {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Insufficient ETH for gas fees. Get some ETH from Ganache.</div>';
            } else if (error.message.includes('MetaMask not installed')) {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå MetaMask not installed. Please install MetaMask.</div>';
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
            }
        }
    }

    // User verification
    function verifyUser() {
        const verificationModal = new bootstrap.Modal(document.getElementById('verificationModal'));
        verificationModal.show();
    }

    async function submitVerification() {
        const statusDiv = document.getElementById('verificationStatus');
        statusDiv.innerHTML = '<div class="alert alert-info">Starting verification...</div>';
        
        try {
            const response = await fetch('/verify_user/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({username: '{{ user }}'})
            });
            
            const result = await response.json();
            if (result.status === 'verified') {
                statusDiv.innerHTML = '<div class="alert alert-success">Account verified successfully!</div>';
            } else {
                throw new Error('Verification failed');
            }
        } catch (error) {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }

    // Auto-refresh completed rides every 10 seconds
    function startAutoRefresh() {
        setInterval(() => {
            loadCompletedRides();
            loadPendingPayments();
        }, 10000);
    }
	

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log("=== USERSCREEN INITIALIZATION ===");
        console.log("Django User:", "{{ user }}");
        console.log("Django Wallet:", "{{ wallet_address }}");
        
        initWeb3().then(() => {
            loadCompletedRides();
            loadScheduledRides();
            loadPendingPayments();
            loadTransactionHistory();
            startAutoRefresh();
        });
    });
    </script>
</body>
</html>